###前提条件

- 准备 TCR 企业版实例，创建镜像仓库。

  前往实例列表页面，新建企业版实例，关于如何创建可参考文档[创建企业版实例](https://cloud.tencent.com/document/product/1141/40716)，并在生成的实例中创建一个镜像仓库。

- 准备 TKE 标准集群，并部署容器应用

  前往 [容器服务控制台](https://console.cloud.tencent.com/tke2)，新建 TKE 标准集群，可参考文档 [创建集群](https://cloud.tencent.com/document/product/457/32189)。

  当前容器服务 TKE 已支持在控制台内选择容器镜像服务 TCR 企业版镜像创建工作负载。同时，TKE 标准集群可安装 TCR 专属插件，实现内网及免密拉取 TCR 企业版内镜像，参考文档 [使用 TCR 企业版实例内容器镜像创建工作负载](https://cloud.tencent.com/document/product/457/45624)。

- 开通 [CODING DevOps](https://cloud.tencent.com/document/product/1115/37268) 服务。

###场景一：代码变动后自动构建镜像，并触发部署

####操作场景

支持用户配置流水线，在代码变更后，自动构建镜像，并触发自动部署到容器平台。

####操作步骤

#####配置交付流水线

1. 登录容器镜像服务 TCR 控制台，选择左侧导航栏中的【[交付流水线](https://console.cloud.tencent.com/tcr/pipeline)】，在“交付流水线”页面中，单击【新建】。

   ![image-20201208155034285](https://main.qcloudimg.com/raw/2e3ca54d46df185771222b62f52bf8a7.png)

2. 在“基本信息”步骤中，配置以下参数，然后单击【下一步：镜像配置】。
   ![image-20201208195156855](https://main.qcloudimg.com/raw/06de5f05b8b6bc22916fc40248d84843.png)

   - **流水线名称**：设置交付流水线名称。
   - **流水线描述**：为交付流水线添加描述信息，创建后可修改。

3. 在“镜像配置”步骤中，配置以下参数，单击【下一步：应用部署】。
   ![image-20201208200109117](https://main.qcloudimg.com/raw/f0724ba2652bf09e77e04d488258a6c9.png)

   - **镜像仓库**：选择交付流水线关联的镜像仓库，将自动配置镜像构建及推送，用于托管应用部署所需要的镜像。
   - **镜像版本过滤**：支持对执行交付流水线中镜像的版本进行限制，可以过滤掉不需要执行部署的镜像版本。
     - **直接部署任意版本**：推送到镜像仓库的任意版本镜像都会被部署。
     - **仅部署指定名称版本**：需指定镜像版本，多个版本可以使用逗号分隔，非指定版本不会部署。
     - **仅部署指定规则版本**：需输入正则表达式。
   - **镜像来源**：支持平台构建镜像和本地推送镜像。平台构建镜像允许用户关联不同代码托管平台的代码仓库，当代码变动时自动触发交付流水线，完成自动构建、推送镜像以及应用部署；本地推送镜像支持用户在手动推送镜像时，也能触发应用部署。场景一中我们选择平台构建镜像。
   - **代码源、代码仓库**：选择用于构建镜像的代码仓库，流水线将拉取该代码仓库内源代码进行编译及构建，首次选择需要授权。目前已支持GitHub、公有GitLab、私有GitLab、码云以及工蜂等代码托管平台。
   - **触发规则**：镜像构建被自动触发的规则条件。目前支持以下四种场景：
     - **推送到指定分支触发**：需指定分支。
     - **推送新标签时触发构建**：新建标签并推送时触发。
     - **推送到分支时触发构建**：推送至任意分支时触发，无需指定分支。
     - **符合分支或标签规则时构建**：需输入正则表达式，例如 `^refs/heads/master$`，可匹配 master 分支进行触发。
   - **Dockerfile 路径**：镜像构建执行的操作基于代码仓库内的 Dockerfile，需指定该 Dockerfile 文件的路径。如不指定，默认为代码仓库根目录下名为 Dockerfile 的文件。
   - **构建目录**：镜像构建执行的工作目录，即上下文环境（context），默认为代码仓库的根目录。
   - **版本规则**：定义镜像构建生成的镜像名称，即镜像版本（tag）。支持配置自定义前缀，并组合加入“分支/标签”，“更新时间”，“commit号” 三个环境变量。其中，更新时间为执行 docker tag 指令时构建服务的系统时间。

4. 在“应用部署”步骤中，配置以下参数，单击【确定】。
   ![image-20201208195440603](https://main.qcloudimg.com/raw/05796fa04f32df62dc6299f8aa702543.png)

   - **部署平台**：交付流水线同时支持容器服务 TKE，弹性容器服务 EKS 及边缘容器服务 Edge。本文以容器服务 TKE 为例。
   - **部署地域**：目标集群所在地域。选择已创建的 TKE 标准集群所在地域。
   - **部署集群**：目标集群。选择已创建的 TKE 标准集群。
   - **部署方式**：当前仅支持 “更新已有工作负载”。
   - **命名空间**：已部署应用所在的命名空间。
   - **工作负载**：已部署应用的关联工作负载。
   - **Pod容器**：已部署应用的工作负载内的 Pod 容器，该容器内使用了上步骤中关联镜像仓库内的镜像。

完成以上配置后，可在“交付流水线” 列表页查看新建的流水线。
![image-20201208204631584](https://main.qcloudimg.com/raw/d8fe3d7827fffd950dc65e71abedcaad.png)

#####更新容器应用

完成以上配置后，即可在更新应用代码后，自动触发镜像构建，推送及应用更新。

1. 更新源代码
   更新源代码，并提交至远端代码仓库。
   ![image-20201208195919986](https://main.qcloudimg.com/raw/00d42c83c07c15d48c090e5ec71107b9.png)
2. 执行流水线
   源代码推送完成后，如符合镜像配置中镜像构建的触发条件，将触发流水线执行。可点击流水线查看该流水线执行记录，并查看具体步骤进度。
   ![image-20201209192911253](https://main.qcloudimg.com/raw/54b77e5f045a9d659b292fe3cfe23c54.png)
   - **Checkout**：检出代码。
   - **Docker Build**：基于镜像构建配置进行镜像构建，并为生成的镜像打上指定规则的Tag，如 v-{tag}-{date}-{commit}。
   - **Docker Push**：推送镜像，自动推送至关联镜像仓库内。
   - **Deploy To TKE**：使用最新推送的镜像更新关联工作负载及Pod 内同名镜像。
3. 查看应用更新状态
   前往容器服务 TKE 控制台，进入上述集群及工作负载详情页，并选择修订历史，可查看应用更新状态。如下图所示，v1版本是一开始手动部署的nginx镜像，流水线执行完成后更新为v2版本，使用的是自动构建出来的新的镜像。
   ![image-20201208204216826](https://main.qcloudimg.com/raw/e3c33a453a4241a6d75a5227724abca8.png)
   可以直接访问该应用服务，查看是否已更新。通过查看Servce 暴露到公网的地址，查看结果，可以看到服务已经更新。
   ![image-20201208204904614](https://main.qcloudimg.com/raw/fff4a6bbec85b2d3567156c280b646bb.png)

###场景二： 本地推送镜像后，自动触发部署

####操作场景

在某些场景可能不需要使用TCR镜像自动构建能力，但又希望可以在推送镜像后能够自动部署到容器平台。TCR支持用户配置本地推送镜像后，通过触发器的能力，自动触发镜像部署。

####操作步骤

#####配置交付流水线

参考场景一配置新建一条交付流水线，与场景一的区别在“镜像配置”步骤中，将”镜像来源“选择为”本地推送镜像“。

![image-20201208023110104](https://main.qcloudimg.com/raw/12d2ff825105a1c1ace7cb5f4c86e3be.png)

#####更新容器应用

完成配置后，即可在本地使用命令行指令推送镜像，触发自动部署。

1. 本地推送镜像

   通过快捷指令我们可以登录腾讯云容器镜像服务 Docker Registry并向 Registry 中推送镜像。例如这里推送一个nginx镜像。

   ![image-20201209200037723](https://main.qcloudimg.com/raw/2a0e0040bf977ff8ceb7a17dd3f4b8e7.png)

2. 执行流水线
   本地推动镜像完成后，如符合镜像配置中镜像构建的触发条件，将触发流水线执行，由于此时镜像已经准备好，因此流水线只需要执行自动部署。
   ![image-20201209195833762](https://main.qcloudimg.com/raw/130b1855e984661c16569db180f37487.png)

3. 查看应用更新状态

   同场景一，我们可以前往容器服务 TKE 控制台，进入上述集群及工作负载详情页，并选择修订历史，可查看应用更新状态，也可直接访问该应用服务，查看是否已更新。

   ![image-20201209201032186](https://main.qcloudimg.com/raw/312732c066cc16dd1eb72c6f50e44e4b.png)

   
